### 01. Controller逻辑
```java
@GetMapping("/api/ticket-service/region-station/query")  
public Result<List<RegionStationQueryRespDTO>> listRegionStationQuery(RegionStationQueryReqDTO request) {  
    log.info("listRegionStationQuery:{},{}", request.getQueryType(), request.getName());  
    return Results.success(trainStationService.listRegionStationQuery(request));  
}
```
在此，我们定义了一个请求实体类。
```java
package cn.foreveryang.my12306.dto.req;  
  
import lombok.Data;  
  
@Data  
public class RegionStationQueryReqDTO {  
    private Integer queryType;  
    private String name;  
}
```
### 02. Service层逻辑
#### 01. 内部方法1
```java
private List<RegionStationQueryRespDTO> safeGetRegionStation(final String key, CacheLoader<String> loader, String param) {  
    List<RegionStationQueryRespDTO> result;  
    if (CollUtil.isNotEmpty(result = JSON.parseArray(distributedCache.get(key, String.class),  
            RegionStationQueryRespDTO.class))) {  
        return result;  
    }  
  
    String lockKey = String.format(LOCK_QUERY_REGION_STATION_LIST, param);  
    RLock lock = redissonClient.getLock(lockKey);  
    lock.lock();  
    try {  
        if (CollUtil.isEmpty(result = JSON.parseArray(distributedCache.get(key, String.class),  
                RegionStationQueryRespDTO.class))) {  
            if (CollUtil.isEmpty(result = loadAndSet(key, loader))) {  
                return Collections.emptyList();  
            }  
        }  
    } finally {  
        lock.unlock();  
    }  
    return result;  
}
```
- 目的：安全地从缓存中获取区域车站查询结果，避免缓存穿透和并发访问问题
核心逻辑：
1. 首先，对缓存进行检查，若不为空，则直接返回。
2. 当为空时，尝试从数据库中读取数据，然后写入redis中。
### 02. 内部方法2
```java
private List<RegionStationQueryRespDTO> loadAndSet(String key, CacheLoader<String> loader) {  
    String result = loader.load();  
    if (CacheUtil.isNullOrBlank(result)) {  
        return Collections.emptyList();  
    }  
    List<RegionStationQueryRespDTO> respDTOList = JSON.parseArray(result, RegionStationQueryRespDTO.class);  
    distributedCache.put(  
            key,  
            result,  
            ADVANCE_TICKET_DAY,  
            TimeUnit.DAYS  
    );  
    return respDTOList;  
}
```
#### 03. 实际方法
```java
@Override  
public List<RegionStationQueryRespDTO> listRegionStationQuery(RegionStationQueryReqDTO request) {  
    String key;  
    if (StrUtil.isNotBlank(request.getName())) {  
        key = REGION_STATION + request.getName();  
        return safeGetRegionStation(  
                key,  
                () -> {  
                    LambdaQueryWrapper<StationDO> queryWrapper = Wrappers.lambdaQuery(StationDO.class)  
                            .like(StationDO::getName, request.getName())  
                            .or()  
                            .likeRight(StationDO::getSpell, request.getName());  
                    List<StationDO> stationDOS = stationMapper.selectList(queryWrapper);  
                    return JSON.toJSONString(BeanUtil.convert(stationDOS, StationQueryRespDTO.class));  
                },  
                request.getName()  
        );  
    }  
    key = REGION_STATION + request.getQueryType();  
    LambdaQueryWrapper<RegionDO> queryWrapper = switch (request.getQueryType()) {  
        case 0 -> Wrappers.lambdaQuery(RegionDO.class)  
                .eq(RegionDO::getPopularFlag, FlagEnum.TRUE.code());  
        case 1 -> Wrappers.lambdaQuery(RegionDO.class)  
                .in(RegionDO::getInitial, RegionStationQueryTypeEnum.A_E.getSpells());  
        case 2 -> Wrappers.lambdaQuery(RegionDO.class)  
                .in(RegionDO::getInitial, RegionStationQueryTypeEnum.F_J.getSpells());  
        case 3 -> Wrappers.lambdaQuery(RegionDO.class)  
                .in(RegionDO::getInitial, RegionStationQueryTypeEnum.K_O.getSpells());  
        case 4 -> Wrappers.lambdaQuery(RegionDO.class)  
                .in(RegionDO::getInitial, RegionStationQueryTypeEnum.P_T.getSpells());  
        case 5 -> Wrappers.lambdaQuery(RegionDO.class)  
                .in(RegionDO::getInitial, RegionStationQueryTypeEnum.U_Z.getSpells());  
        default -> throw new ClientException("查询失败，请检查查询参数是否正确");  
    };  
      
    return safeGetRegionStation(  
            key,  
            () -> {  
                List<RegionDO> regionDOS = regionMapper.selectList(queryWrapper);  
                return JSON.toJSONString(BeanUtil.convert(regionDOS, RegionStationQueryRespDTO.class));  
            },  
            String.valueOf(request.getQueryType())  
    );  
}
```